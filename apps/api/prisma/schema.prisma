generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model SiteConfig {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100)
  value       String?  @db.Text
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Agente {
  id                    String                 @id @default(uuid()) @db.Uuid
  nombre                String
  usuario               String                 @unique @db.VarChar(50)
  password              String
  email                 String?
  role                  AgenteRole             @default(AGENTE)
  activo                Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  roles                 AgenteRoleAssignment[]
  clienteComentarios    ClienteComentario[]
  clienteReleasesPlan   ClienteReleasePlan[]
  notificacionesMasivas NotificacionMasiva[]
  tareasAsignadas       Tarea[]                @relation("TareaAsignadaAAgente")
  tareasCreadas         Tarea[]                @relation("TareaCreadaPorAgente")
  tareasRevisadas       Tarea[]                @relation("TareaRevisadaPorAgente")
  eventos               TareaEvento[]          @relation("EventoCreadoPorAgente")
}

model Cliente {
  id             String                 @id @default(uuid()) @db.Uuid
  codigo         String                 @unique @db.VarChar(50)
  descripcion    String?
  logotipo       String?
  jefeProyecto1  String?                @db.VarChar(50)
  jefeProyecto2  String?                @db.VarChar(50)
  licenciaTipo   LicenciaTipo?
  activo         Boolean                @default(true)
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  centrosTrabajo ClienteCentroTrabajo[]
  comentarios    ClienteComentario[]
  conexiones     ClienteConexion[]
  contactos      ClienteContacto[]
  releasesPlan   ClienteReleasePlan[]
  softwares      ClienteSoftware[]
  tareas         Tarea[]
  unidades       UnidadComercial[]
  usuarios       ClienteUsuario[]
}

model UnidadComercial {
  id          String               @id @default(uuid()) @db.Uuid
  codigo      String               @db.VarChar(50)
  descripcion String?
  activo      Boolean              @default(true)
  scope       UnidadComercialScope @default(HOTEL)
  clienteId   String               @db.Uuid
  tareas      Tarea[]
  cliente     Cliente              @relation(fields: [clienteId], references: [id])

  @@unique([clienteId, codigo], name: "clienteId_codigo", map: "uq_unidadcomercial_cliente_codigo")
  @@index([clienteId, scope])
}

model ClienteUsuario {
  id                   String                 @id @default(uuid()) @db.Uuid
  nombre               String
  usuario              String                 @unique
  password             String
  email                String?
  telefono             String?
  tipo                 String?                @db.VarChar(50)
  activo               Boolean                @default(true)
  principal            Boolean                @default(false)
  clienteId            String                 @db.Uuid
  recibeNotificaciones Boolean                @default(true)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  tareasCreadas        Tarea[]                @relation("TareaCreadaPorCliente")
  eventos              TareaEvento[]          @relation("EventoCreadoPorCliente")
  cliente              Cliente                @relation(fields: [clienteId], references: [id])
  modulos              ClienteUsuarioModulo[]

  @@index([clienteId])
  @@map("usuario_cliente")
}

model TipoTarea {
  id               String               @id @default(uuid()) @db.Uuid
  codigo           String               @unique @db.VarChar(50)
  descripcion      String?
  orden            Int                  @default(0)
  porDefecto       Boolean              @default(false)
  activo           Boolean              @default(true)
  // Related lookup table name for secondary status (e.g., "EstadoPeticion")
  // When set, tasks of this type will show this additional status field
  tablaRelacionada String?              @db.VarChar(50)
  tareas           Tarea[]
  estadoFlow       TipoTareaEstadoFlow?
  estadoPeticionFlow TipoTareaEstadoPeticionFlow?
}

model EstadoTarea {
  id                  String                @id @default(uuid()) @db.Uuid
  codigo              String                @unique @db.VarChar(50)
  descripcion         String?
  orden               Int                   @default(0)
  porDefecto          Boolean               @default(false)
  activo              Boolean               @default(true)
  tareas              Tarea[]
  flowsInicial        TipoTareaEstadoFlow[] @relation("EstadoInicial")
  flowEstados         TipoTareaEstado[]
  transicionesOrigen  TipoTareaTransicion[] @relation("TransicionOrigen")
  transicionesDestino TipoTareaTransicion[] @relation("TransicionDestino")
}

model PrioridadTarea {
  id          String  @id @default(uuid()) @db.Uuid
  codigo      String  @unique @db.VarChar(50)
  descripcion String?
  orden       Int     @default(0)
  porDefecto  Boolean @default(false)
  color       String?
  activo      Boolean @default(true)
  tareas      Tarea[]
}

model EstadoPeticion {
  id          String  @id @default(uuid()) @db.Uuid
  codigo      String  @unique @db.VarChar(50)
  descripcion String?
  orden       Int     @default(0)
  porDefecto  Boolean @default(false)
  activo      Boolean @default(true)
  tareas      Tarea[]
  // Flow relations
  flowsInicial        TipoTareaEstadoPeticionFlow[] @relation("EstadoPeticionInicial")
  flowEstados         TipoTareaEstadoPeticion[]
  transicionesOrigen  TipoTareaTransicionPeticion[] @relation("TransicionPeticionOrigen")
  transicionesDestino TipoTareaTransicionPeticion[] @relation("TransicionPeticionDestino")
}

model Modulo {
  id               String                 @id @default(uuid()) @db.Uuid
  codigo           String                 @unique @db.VarChar(80)
  descripcion      String?
  activo           Boolean                @default(true)
  clienteSoftwares ClienteSoftware[]
  tareas           Tarea[]
  clienteUsuarios  ClienteUsuarioModulo[]
}

model Release {
  id              String               @id @default(uuid()) @db.Uuid
  codigo          String               @unique @db.VarChar(50)
  descripcion     String?
  rama            RamaTipo             @default(DESARROLLO)
  clienteReleases ClienteReleasePlan[]
  hotfixes        Hotfix[]
  tareas          Tarea[]
}

model Hotfix {
  id              String               @id @default(uuid()) @db.Uuid
  codigo          String               @db.VarChar(50)
  descripcion     String?
  rama            RamaTipo             @default(DESARROLLO)
  releaseId       String               @db.Uuid
  clienteReleases ClienteReleasePlan[]
  release         Release              @relation(fields: [releaseId], references: [id])
  tareas          Tarea[]

  @@unique([releaseId, codigo])
}

model Tarea {
  id                 String              @id @default(uuid()) @db.Uuid
  numero             String              @unique @db.VarChar(15)
  titulo             String
  clienteId          String              @db.Uuid
  unidadComercialId  String              @db.Uuid
  tipoId             String              @db.Uuid
  estadoId           String?             @db.Uuid
  prioridadId        String              @db.Uuid
  moduloId           String?             @db.Uuid
  releaseId          String?             @db.Uuid
  hotfixId           String?             @db.Uuid
  reproducido        Boolean             @default(false)
  creadoPorAgenteId  String?             @db.Uuid
  creadoPorClienteId String?             @db.Uuid
  asignadoAId        String?             @db.Uuid
  revisadoPorId      String?             @db.Uuid
  estadoPeticionId   String?             @db.Uuid
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  closedAt           DateTime?
  asignadoA          Agente?             @relation("TareaAsignadaAAgente", fields: [asignadoAId], references: [id], onDelete: Restrict)
  cliente            Cliente             @relation(fields: [clienteId], references: [id])
  creadoPorAgente    Agente?             @relation("TareaCreadaPorAgente", fields: [creadoPorAgenteId], references: [id], onDelete: Restrict)
  creadoPorCliente   ClienteUsuario?     @relation("TareaCreadaPorCliente", fields: [creadoPorClienteId], references: [id], onDelete: Restrict)
  estado             EstadoTarea?        @relation(fields: [estadoId], references: [id], onDelete: Restrict)
  estadoPeticion     EstadoPeticion?     @relation(fields: [estadoPeticionId], references: [id], onDelete: Restrict)
  hotfix             Hotfix?             @relation(fields: [hotfixId], references: [id], onDelete: Restrict)
  modulo             Modulo?             @relation(fields: [moduloId], references: [id], onDelete: Restrict)
  prioridad          PrioridadTarea      @relation(fields: [prioridadId], references: [id])
  release            Release?            @relation(fields: [releaseId], references: [id], onDelete: Restrict)
  revisadoPor        Agente?             @relation("TareaRevisadaPorAgente", fields: [revisadoPorId], references: [id], onDelete: Restrict)
  tipo               TipoTarea           @relation(fields: [tipoId], references: [id])
  unidadComercial    UnidadComercial     @relation(fields: [unidadComercialId], references: [id])
  eventos            TareaEvento[]
  notificaciones     NotificacionTarea[]

  @@index([clienteId, createdAt])
  @@index([tipoId, estadoId])
  @@index([prioridadId])
  @@index([moduloId])
}

model TareaEvento {
  id                 String              @id @default(uuid()) @db.Uuid
  tareaId            String              @db.Uuid
  tipo               EventoTipo
  canal              String?             @db.VarChar(50)
  asunto             String?
  cuerpo             String?
  payload            Json?
  actorTipo          ActorTipo
  creadoPorAgenteId  String?             @db.Uuid
  creadoPorClienteId String?             @db.Uuid
  visibleEnTimeline  Boolean             @default(true)
  visibleParaCliente Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime?
  creadoPorAgente    Agente?             @relation("EventoCreadoPorAgente", fields: [creadoPorAgenteId], references: [id], onDelete: Restrict)
  creadoPorCliente   ClienteUsuario?     @relation("EventoCreadoPorCliente", fields: [creadoPorClienteId], references: [id], onDelete: Restrict)
  tarea              Tarea               @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  notificaciones     NotificacionTarea[]

  @@index([tareaId, createdAt])
  @@index([visibleEnTimeline])
  @@index([visibleParaCliente])
}

model ClienteUsuarioModulo {
  id               String         @id @default(uuid()) @db.Uuid
  clienteUsuarioId String         @db.Uuid
  moduloId         String         @db.Uuid
  clienteUsuario   ClienteUsuario @relation(fields: [clienteUsuarioId], references: [id], onDelete: Cascade)
  modulo           Modulo         @relation(fields: [moduloId], references: [id], onDelete: Cascade)

  @@unique([clienteUsuarioId, moduloId])
  @@map("usuario_cliente_modulo")
}

model RoleEntity {
  id          String                 @id @default(uuid()) @db.Uuid
  codigo      String                 @unique
  nombre      String
  descripcion String?
  createdAt   DateTime               @default(now())
  agentes     AgenteRoleAssignment[]
  permisos    RolePermission[]
}

model Permission {
  id          String           @id @default(uuid()) @db.Uuid
  codigo      PermisoCodigo    @unique
  descripcion String?
  createdAt   DateTime         @default(now())
  roles       RolePermission[]
}

model RolePermission {
  roleId       String     @db.Uuid
  permissionId String     @db.Uuid
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         RoleEntity @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model AgenteRoleAssignment {
  agenteId String     @db.Uuid
  roleId   String     @db.Uuid
  agente   Agente     @relation(fields: [agenteId], references: [id], onDelete: Cascade)
  role     RoleEntity @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([agenteId, roleId])
}

model ClienteSoftware {
  id        String              @id @default(uuid()) @db.Uuid
  clienteId String              @db.Uuid
  tipo      ClienteSoftwareTipo
  nombre    String              @db.VarChar(200)
  version   String?             @db.VarChar(100)
  moduloId  String?             @db.Uuid
  notas     String?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  cliente   Cliente             @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  modulo    Modulo?             @relation(fields: [moduloId], references: [id])

  @@unique([clienteId, tipo, nombre], name: "clienteId_tipo_nombre")
  @@index([clienteId])
}

model ClienteContacto {
  id        String   @id @default(uuid()) @db.Uuid
  clienteId String   @db.Uuid
  nombre    String   @db.VarChar(200)
  cargo     String?  @db.VarChar(150)
  email     String?  @db.VarChar(200)
  movil     String?  @db.VarChar(50)
  principal Boolean  @default(false)
  notas     String?
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId])
}

model ClienteConexion {
  id        String   @id @default(uuid()) @db.Uuid
  clienteId String   @db.Uuid
  nombre    String   @db.VarChar(200)
  endpoint  String?  @db.VarChar(500)
  usuario   String?  @db.VarChar(150)
  secretRef String?  @db.VarChar(500)
  notas     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId])
}

model ClienteComentario {
  id        String   @id @default(uuid()) @db.Uuid
  clienteId String   @db.Uuid
  agenteId  String   @db.Uuid
  texto     String
  destacado Boolean  @default(false)
  createdAt DateTime @default(now())
  agente    Agente   @relation(fields: [agenteId], references: [id])
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId])
}

model ClienteCentroTrabajo {
  id        String   @id @default(uuid()) @db.Uuid
  clienteId String   @db.Uuid
  nombre    String   @db.VarChar(250)
  baseDatos String?  @db.VarChar(250)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId])
}

model ClienteReleasePlan {
  id             String               @id @default(uuid()) @db.Uuid
  clienteId      String               @db.Uuid
  releaseId      String               @db.Uuid
  hotfixId       String?              @db.Uuid
  fechaPrevista  DateTime?
  fechaInstalada DateTime?
  estado         ClienteReleaseEstado @default(PLANIFICADO)
  agenteId       String?              @db.Uuid
  detalle        String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  agente         Agente?              @relation(fields: [agenteId], references: [id])
  cliente        Cliente              @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  hotfix         Hotfix?              @relation(fields: [hotfixId], references: [id])
  release        Release              @relation(fields: [releaseId], references: [id])

  @@index([clienteId])
}

model ConfiguracionMail {
  id                String        @id @default(uuid()) @db.Uuid
  tipoSeguridad     TipoSeguridad @default(NINGUNO)
  urlServidor       String?       @db.VarChar(500)
  puerto            Int?
  cuentaMail        String?       @db.VarChar(200)
  usuarioMail       String?       @db.VarChar(200)
  passwordMail      String?
  azureClientId     String?       @db.VarChar(200)
  azureTenantId     String?       @db.VarChar(200)
  azureClientSecret String?
  azureAccessToken  String?
  azureTokenExpiry  DateTime?
  firmaHtml         String?       @db.Text
  activo            Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

model NotificacionMasiva {
  id             String    @id @default(uuid()) @db.Uuid
  asunto         String    @db.VarChar(500)
  cuerpoHtml     String
  cuerpoTexto    String?
  clienteIds     String[]  @db.Uuid
  emailsManuales String[]
  emailsTo       String[]
  emailsCc       String[]
  roleCcId       String?   @db.Uuid
  adjuntos       Json?
  programadoAt   DateTime?
  enviadoPor     String    @db.Uuid
  estado         String    @default("PENDIENTE") @db.VarChar(50)
  enviados       Int       @default(0)
  errores        Int       @default(0)
  logEnvio       String?
  retryCount     Int       @default(0)
  lastRetryAt    DateTime?
  maxRetries     Int       @default(3)
  createdAt      DateTime  @default(now())
  enviadoAt      DateTime?
  agente         Agente    @relation(fields: [enviadoPor], references: [id])

  @@index([enviadoPor])
  @@index([createdAt])
  @@index([estado, programadoAt])
}

enum AgenteRole {
  ADMIN
  AGENTE
}

enum ActorTipo {
  AGENTE
  CLIENTE
}

enum EventoTipo {
  MENSAJE_CLIENTE
  RESPUESTA_AGENTE
  NOTA_INTERNA
  CAMBIO_ESTADO
  ASIGNACION
  CAMBIO_PRIORIDAD
  CAMBIO_TIPO
  CAMBIO_MODULO
  CAMBIO_RELEASE_HOTFIX
  CAMBIO_ESTADO_PETICION
  SISTEMA
}

enum LicenciaTipo {
  AAM
  PPU
}

enum UnidadComercialScope {
  HOTEL
  CENTRAL
  TODOS
}

enum PermisoCodigo {
  CONFIG_GENERAL
  CONFIG_MAESTROS
  CONFIG_AGENTES
  CONFIG_CLIENTES
  CONFIG_CLIENTES_READ
  CONFIG_UNIDADES
  CONFIG_MODULOS
  CONFIG_RELEASES
  CONFIG_RBAC
  CONFIG_NOTIFICACIONES
}

enum ClienteSoftwareTipo {
  PMS
  ERP
  PERIFERIA
  OTROS
  GP
  PM
  PLATAFORMA
  OTRO
}

enum ClienteReleaseEstado {
  PLANIFICADO
  EN_CURSO
  INSTALADO
  CANCELADO
}

enum TipoSeguridad {
  NINGUNO
  TLS
  SSL
  AZURE
}

enum RamaTipo {
  DESARROLLO
  PRODUCCION
}

enum TipoNotificacion {
  EMAIL
  APP // Future: real-time notifications
}

enum EstadoNotificacion {
  PENDIENTE
  PROCESANDO
  ENVIADO
  ERROR
  CANCELADO
}

model Plantilla {
  id                  String                     @id @default(uuid()) @db.Uuid
  codigo              String                     @unique @db.VarChar(50)
  descripcion         String?
  texto               String                     @db.Text
  categoria           String?                    @db.VarChar(50)
  orden               Int                        @default(0)
  activo              Boolean                    @default(true)
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  notificacionConfigs NotificacionConfigEvento[]
  workflows           NotificationWorkflow[]
}

// Notification configuration per event type
model NotificacionConfigEvento {
  id               String     @id @default(uuid()) @db.Uuid
  eventoTipo       EventoTipo @unique
  habilitado       Boolean    @default(true)
  notificarCliente Boolean    @default(true)
  notificarAgente  Boolean    @default(true)
  plantillaId      String?    @db.Uuid
  asuntoDefault    String?    @db.VarChar(500)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  plantilla        Plantilla? @relation(fields: [plantillaId], references: [id])
}

// Task notification queue
model NotificacionTarea {
  id               String           @id @default(uuid()) @db.Uuid
  tareaId          String           @db.Uuid
  eventoId         String?          @db.Uuid
  eventoTipo       EventoTipo
  tipoNotificacion TipoNotificacion @default(EMAIL)

  emailsTo    String[]
  emailsCc    String[]
  asunto      String   @db.VarChar(500)
  cuerpoHtml  String
  cuerpoTexto String?

  estado      EstadoNotificacion @default(PENDIENTE)
  prioridad   Int                @default(0)
  retryCount  Int                @default(0)
  maxRetries  Int                @default(3)
  nextRetryAt DateTime?

  logEnvio     String? @db.Text
  errorMessage String?

  createdAt DateTime  @default(now())
  enviadoAt DateTime?

  tarea  Tarea        @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  evento TareaEvento? @relation(fields: [eventoId], references: [id], onDelete: SetNull)

  @@index([estado, nextRetryAt])
  @@index([tareaId])
  @@index([createdAt])
}

// Dashboard configuration - stores widget layout and filters
// isDefault=true means this is the shared config all agents see
// When an admin saves, it updates the default config
model DashboardConfig {
  id          String   @id @default(uuid()) @db.Uuid
  nombre      String   @db.VarChar(100)
  isDefault   Boolean  @default(false)
  // JSON structure for widget layout: { widgets: [{ id, type, position: {x,y,w,h}, filters: {...} }] }
  layout      Json
  createdById String?  @db.Uuid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([isDefault], map: "unique_default_dashboard")
}

// ============================================================================
// NOTIFICATION WORKFLOW SYSTEM
// Allows admins to create flexible rules for when and to whom notifications are sent
// ============================================================================

// Trigger types - WHEN the workflow is evaluated
enum WorkflowTrigger {
  TAREA_CREADA           // New task created
  TAREA_MODIFICADA       // Task updated (any field)
  TAREA_CERRADA          // Task closed
  MENSAJE_CLIENTE        // Client sends message
  RESPUESTA_AGENTE       // Agent responds
  NOTA_INTERNA           // Internal note added
  CAMBIO_ESTADO          // Status changed
  CAMBIO_ASIGNACION      // Assignment changed
  CAMBIO_PRIORIDAD       // Priority changed
  CAMBIO_TIPO            // Type changed
  CAMBIO_MODULO          // Module changed
  CAMBIO_RELEASE         // Release/hotfix changed
  CAMBIO_ESTADO_PETICION // Estado Peticion changed
}

// Condition field types - WHAT to compare
enum WorkflowConditionField {
  CLIENTE_ID             // Specific client(s)
  CLIENTE_CODIGO         // Client code
  ESTADO_ID              // Task status
  ESTADO_CODIGO          // Status code
  TIPO_ID                // Task type
  TIPO_CODIGO            // Type code
  PRIORIDAD_ID           // Priority
  PRIORIDAD_CODIGO       // Priority code
  MODULO_ID              // Module
  MODULO_CODIGO          // Module code
  RELEASE_ID             // Release
  RELEASE_CODIGO         // Release code
  RELEASE_RAMA           // Release branch (DESARROLLO/PRODUCCION)
  HOTFIX_ID              // Hotfix
  ASIGNADO_A_ID          // Assigned agent
  CREADO_POR_AGENTE_ID   // Created by agent
  CREADO_POR_CLIENTE_ID  // Created by client user
  UNIDAD_COMERCIAL_ID    // Commercial unit
  UNIDAD_COMERCIAL_SCOPE // Unit scope (HOTEL/CENTRAL/TODOS)
  REPRODUCIDO            // Bug reproduced flag
  // For change events, we can also compare old vs new values
  ESTADO_ANTERIOR_ID     // Previous status (for CAMBIO_ESTADO)
  ESTADO_NUEVO_ID        // New status (for CAMBIO_ESTADO)
  PRIORIDAD_ANTERIOR_ID  // Previous priority
  PRIORIDAD_NUEVA_ID     // New priority
  // For CAMBIO_TIPO events
  TIPO_ANTERIOR_ID       // Previous type (for CAMBIO_TIPO)
  TIPO_NUEVO_ID          // New type (for CAMBIO_TIPO)
  // For CAMBIO_MODULO events
  MODULO_ANTERIOR_ID     // Previous module
  MODULO_NUEVO_ID        // New module
  // For CAMBIO_RELEASE events
  RELEASE_ANTERIOR_ID    // Previous release
  RELEASE_NUEVO_ID       // New release
  // For CAMBIO_ESTADO_PETICION events
  ESTADO_PETICION_ID           // Current estado peticion
  ESTADO_PETICION_CODIGO       // Estado peticion code
  ESTADO_PETICION_ANTERIOR_ID  // Previous estado peticion
  ESTADO_PETICION_NUEVO_ID     // New estado peticion
  ESTADO_PETICION_ANTERIOR_CODIGO  // Previous estado peticion code
  ESTADO_PETICION_NUEVO_CODIGO     // New estado peticion code
}

// Comparison operators
enum WorkflowConditionOperator {
  EQUALS                 // Exact match
  NOT_EQUALS             // Not equal
  IN                     // In list (for multi-select)
  NOT_IN                 // Not in list
  IS_NULL                // Field is null/empty
  IS_NOT_NULL            // Field has value
  CONTAINS               // String contains
  STARTS_WITH            // String starts with
}

// Recipient types - WHO receives the notification
enum WorkflowRecipientType {
  USUARIOS_CLIENTE       // All active users of the task's client with notifications enabled
  USUARIO_CLIENTE_CREADOR // The client user who created the task
  JEFE_PROYECTO_1        // JP1 of the client
  JEFE_PROYECTO_2        // JP2 of the client
  AGENTE_ASIGNADO        // Currently assigned agent
  AGENTE_CREADOR         // Agent who created the task
  AGENTE_REVISOR         // Agent who reviewed
  AGENTES_ESPECIFICOS    // Specific agent(s) by ID
  ROLES_ESPECIFICOS      // All agents with specific role(s)
  EMAILS_MANUALES        // Manual email addresses
}

// Main workflow model
model NotificationWorkflow {
  id          String           @id @default(uuid()) @db.Uuid
  nombre      String           @db.VarChar(200)
  descripcion String?          @db.Text
  trigger     WorkflowTrigger
  activo      Boolean          @default(true)
  orden       Int              @default(0)     // Execution order

  // If true, stops processing subsequent workflows after this one matches
  stopOnMatch Boolean          @default(false)

  // Template and email configuration
  plantillaId   String?        @db.Uuid
  asuntoCustom  String?        @db.VarChar(500)

  // Optional CC configuration
  ccJefeProyecto1 Boolean      @default(false)
  ccJefeProyecto2 Boolean      @default(false)

  createdById String?          @db.Uuid
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  plantilla   Plantilla?                  @relation(fields: [plantillaId], references: [id])
  conditions  NotificationWorkflowCondition[]
  recipients  NotificationWorkflowRecipient[]
  actions     NotificationWorkflowAction[]

  @@index([trigger, activo])
  @@index([orden])
}

// Workflow conditions - filtering rules (AND logic between conditions)
model NotificationWorkflowCondition {
  id         String                    @id @default(uuid()) @db.Uuid
  workflowId String                    @db.Uuid
  field      WorkflowConditionField
  operator   WorkflowConditionOperator
  // Value can be a single ID, list of IDs (JSON array), or string
  value      String?                   @db.Text
  // For complex conditions, allow grouping with OR logic
  orGroup    Int                       @default(0) // Conditions in same orGroup use OR logic

  workflow   NotificationWorkflow      @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

// Workflow action types - WHAT changes to make when conditions match
enum WorkflowActionType {
  CAMBIAR_ESTADO
  CAMBIAR_PRIORIDAD
  CAMBIAR_TIPO
  ASIGNAR_AGENTE
  CAMBIAR_MODULO
  CAMBIAR_RELEASE
}

// Workflow actions - automated field changes when workflow matches
model NotificationWorkflowAction {
  id         String              @id @default(uuid()) @db.Uuid
  workflowId String              @db.Uuid
  actionType WorkflowActionType
  value      String?             @db.Text  // ID of the new value (e.g., estadoId, agenteId)
  orden      Int                 @default(0)

  workflow   NotificationWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

// Workflow recipients - who receives the notification
model NotificationWorkflowRecipient {
  id           String                @id @default(uuid()) @db.Uuid
  workflowId   String                @db.Uuid
  recipientType WorkflowRecipientType
  // For AGENTES_ESPECIFICOS: JSON array of agent IDs
  // For ROLES_ESPECIFICOS: JSON array of role IDs
  // For EMAILS_MANUALES: JSON array of email strings
  value        String?               @db.Text
  // Whether this recipient goes to To or Cc
  isCc         Boolean               @default(false)

  workflow     NotificationWorkflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

// ============================================================================
// TASK STATE MACHINE / PROCESS WORKFLOW
// Defines allowed state transitions per task type
// ============================================================================

// State flow definition for a task type
model TipoTareaEstadoFlow {
  id              String      @id @default(uuid()) @db.Uuid
  tipoTareaId     String      @unique @db.Uuid
  tipoTarea       TipoTarea   @relation(fields: [tipoTareaId], references: [id], onDelete: Cascade)

  // Allowed statuses for this task type
  estadosPermitidos TipoTareaEstado[]

  // Transitions between statuses
  transiciones    TipoTareaTransicion[]

  // Initial status for new tasks of this type (overrides EstadoTarea.porDefecto)
  estadoInicialId String?     @db.Uuid
  estadoInicial   EstadoTarea? @relation("EstadoInicial", fields: [estadoInicialId], references: [id])

  activo          Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

// Which statuses are allowed for a task type
model TipoTareaEstado {
  id              String      @id @default(uuid()) @db.Uuid
  flowId          String      @db.Uuid
  flow            TipoTareaEstadoFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)
  estadoId        String      @db.Uuid
  estado          EstadoTarea @relation(fields: [estadoId], references: [id])

  orden           Int         @default(0)  // Display order in this flow
  visibleCliente  Boolean     @default(true)  // Can clients see this status?

  @@unique([flowId, estadoId])
  @@index([flowId])
}

// Allowed transitions between statuses
model TipoTareaTransicion {
  id              String      @id @default(uuid()) @db.Uuid
  flowId          String      @db.Uuid
  flow            TipoTareaEstadoFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  estadoOrigenId  String      @db.Uuid
  estadoOrigen    EstadoTarea @relation("TransicionOrigen", fields: [estadoOrigenId], references: [id])

  estadoDestinoId String      @db.Uuid
  estadoDestino   EstadoTarea @relation("TransicionDestino", fields: [estadoDestinoId], references: [id])

  // Who can make this transition
  permiteAgente   Boolean     @default(true)
  permiteCliente  Boolean     @default(false)

  // Optional: trigger notification workflow on this transition
  notificar       Boolean     @default(false)

  orden           Int         @default(0)  // Order in dropdown

  @@unique([flowId, estadoOrigenId, estadoDestinoId])
  @@index([flowId, estadoOrigenId])
}

// ============================================================================
// ESTADO PETICION FLOW (Secondary status workflow)
// Defines allowed EstadoPeticion transitions per task type
// Only applies when TipoTarea.tablaRelacionada = "EstadoPeticion"
// ============================================================================

// State flow definition for EstadoPeticion per task type
model TipoTareaEstadoPeticionFlow {
  id              String      @id @default(uuid()) @db.Uuid
  tipoTareaId     String      @unique @db.Uuid
  tipoTarea       TipoTarea   @relation(fields: [tipoTareaId], references: [id], onDelete: Cascade)

  // Allowed EstadoPeticion values for this task type
  estadosPermitidos TipoTareaEstadoPeticion[]

  // Transitions between EstadoPeticion values
  transiciones    TipoTareaTransicionPeticion[]

  // Initial EstadoPeticion for new tasks of this type (overrides EstadoPeticion.porDefecto)
  estadoInicialId String?     @db.Uuid
  estadoInicial   EstadoPeticion? @relation("EstadoPeticionInicial", fields: [estadoInicialId], references: [id])

  activo          Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

// Which EstadoPeticion values are allowed for a task type
model TipoTareaEstadoPeticion {
  id              String      @id @default(uuid()) @db.Uuid
  flowId          String      @db.Uuid
  flow            TipoTareaEstadoPeticionFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)
  estadoId        String      @db.Uuid
  estado          EstadoPeticion @relation(fields: [estadoId], references: [id])

  orden           Int         @default(0)  // Display order in this flow
  visibleCliente  Boolean     @default(true)  // Can clients see this status?

  @@unique([flowId, estadoId])
  @@index([flowId])
}

// Allowed transitions between EstadoPeticion values
model TipoTareaTransicionPeticion {
  id              String      @id @default(uuid()) @db.Uuid
  flowId          String      @db.Uuid
  flow            TipoTareaEstadoPeticionFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  estadoOrigenId  String      @db.Uuid
  estadoOrigen    EstadoPeticion @relation("TransicionPeticionOrigen", fields: [estadoOrigenId], references: [id])

  estadoDestinoId String      @db.Uuid
  estadoDestino   EstadoPeticion @relation("TransicionPeticionDestino", fields: [estadoDestinoId], references: [id])

  // Who can make this transition
  permiteAgente   Boolean     @default(true)
  permiteCliente  Boolean     @default(false)

  // Optional: trigger notification workflow on this transition
  notificar       Boolean     @default(false)

  orden           Int         @default(0)  // Order in dropdown

  @@unique([flowId, estadoOrigenId, estadoDestinoId])
  @@index([flowId, estadoOrigenId])
}
